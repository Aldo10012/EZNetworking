name: Build and Test

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  # -------------------------
  # Platform Builds
  # -------------------------
  build-macos:
    name: Build macOS
    uses: ./.github/workflows/reusable-build.yml
    with:
      platform: macOS
      swift-versions: '["5.10", "6.0", "6.1", "6.2"]'

  build-iOS:
    name: Build iOS
    uses: ./.github/workflows/reusable-build.yml
    with:
      platform: iOS
      swift-versions: '["6.2"]'

  build-watchOS:
    name: Build watchOS
    uses: ./.github/workflows/reusable-build.yml
    with:
      platform: watchOS
      swift-versions: '["6.2"]'

  build-tvOS:
    name: Build tvOS
    uses: ./.github/workflows/reusable-build.yml
    with:
      platform: tvOS
      swift-versions: '["6.2"]'

  build-visionOS:
    name: Build visionOS
    uses: ./.github/workflows/reusable-build.yml
    with:
      platform: visionOS
      swift-versions: '["6.2"]'

  # -------------------------
  # Testing
  # -------------------------
  test:
    name: Test
    runs-on: macos-14
    needs: [build-macos, build-ios, build-watchOS, build-tvOS, build-visionOS]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Swift 6.2
        uses: swift-actions/setup-swift@v2
        with:
          swift-version: '6.2'
      
      - name: Cache Swift Package Manager
        uses: actions/cache@v4
        with:
          path: .build
          key: ${{ runner.os }}-spm-test-6.2-${{ hashFiles('**/Package.resolved') }}
          restore-keys: |
            ${{ runner.os }}-spm-test-6.2-
            ${{ runner.os }}-spm-
      
      - name: Run Tests
        run: swift test --enable-code-coverage
      
      # --- Coverage Reporting (Non-blocking) ---
      
      - name: Get Package Name
        id: package-name
        continue-on-error: true
        run: |
          PACKAGE_NAME=$(swift package describe --type json | jq -r '.name')
          echo "name=$PACKAGE_NAME" >> $GITHUB_OUTPUT
      
      - name: Display Coverage Summary
        if: steps.package-name.outcome == 'success'
        continue-on-error: true
        run: |
          SWIFT_PATH=$(which swift)
          TOOLCHAIN_PATH=$(dirname $(dirname $SWIFT_PATH))
          $TOOLCHAIN_PATH/usr/bin/llvm-cov report \
            -instr-profile .build/arm64-apple-macosx/debug/codecov/default.profdata \
            .build/arm64-apple-macosx/debug/${{ steps.package-name.outputs.name }}PackageTests.xctest/Contents/MacOS/${{ steps.package-name.outputs.name }}PackageTests
      
      - name: Generate Coverage Report (LCOV)
        if: steps.package-name.outcome == 'success'
        continue-on-error: true
        run: |
          SWIFT_PATH=$(which swift)
          TOOLCHAIN_PATH=$(dirname $(dirname $SWIFT_PATH))
          $TOOLCHAIN_PATH/usr/bin/llvm-cov export \
            -instr-profile .build/arm64-apple-macosx/debug/codecov/default.profdata \
            .build/arm64-apple-macosx/debug/${{ steps.package-name.outputs.name }}PackageTests.xctest/Contents/MacOS/${{ steps.package-name.outputs.name }}PackageTests \
            -format="lcov" > coverage.lcov
      
      - name: Upload Coverage Artifact
        if: steps.package-name.outcome == 'success'
        continue-on-error: true
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report-swift-6.2
          path: coverage.lcov
          retention-days: 30